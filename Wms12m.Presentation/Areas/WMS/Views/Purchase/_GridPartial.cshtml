@model List<IRS_Detay>
@if (ViewBag.message != null)
{
    @ViewBag.message
}
else
{
    using (Ajax.BeginForm("InsertMalzeme", "Purchase", new { area = "WMS" }, new AjaxOptions { InsertionMode = InsertionMode.Replace, UpdateTargetId = "StoreGrid", OnSuccess = "getresult", OnFailure = "Modaldialog('Lütfen Tekrar Deneyin', 'Hata', 'Tamam', 'btn-danger');" }, new { @class = "form-horizontal" }))
    {
        string tmp = ViewBag.SirketID;
        <table class="table table-striped table-bordered table-hover" id="sample_7">
            <thead><tr><th></th><th>Malzeme Kodu</th><th>Malzeme Adı</th><th>Miktar</th><th>Birim</th><th>Makara No</th><th>İşlem</th></tr></thead>
            <tbody id="StoreFrom">
                @{if (ViewBag.Onay == false) { Html.RenderAction("NewMalzemeForm", new { id = ViewBag.IrsaliyeId }); } }
                @foreach (var item in Model)
                {
                    <tr id="tr@{@item.ID}">
                        <td></td>
                        <td>@item.MalKodu</td>
                        <td>@item.MalKodu.GetMalAdi(tmp)</td>
                        <td align="right">@String.Format("{0:n}", item.Miktar)</td>
                        <td>@item.Birim</td>
                        <td>@item.MakaraNo</td>
                        <td>@if (ViewBag.Onay == false)
                        {
                            <a class="btn btn-default input-circle" href="javascript:;" onclick="editlist(@item.ID)"> Değiştir </a>
                            <a class="btn btn-danger input-circle" href="javascript:;" onclick="Delete('@item.ID','/WMS/Purchase/GridPartial','StoreGrid','@ViewBag.IrsaliyeId', '')"> Sil </a>
                        }</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    <input type="hidden" id="IrsNo" value="@ViewBag.IrsaliyeId" />
    <script>
        disableAll()
        @{ if (ViewBag.Onay == false && ViewBag.Yetki == true) { <text>$(".showlater").show();</text> } else { <text>$(".showlater").hide();</text> } }
        $("#MalKodu").focus();
        $("#MalKodu").autocomplete({
            source: "/WMS/Purchase/GetMalzemebyCode/" + $("#SirketID").val(),
            minLength: 2,
            select: function (event, ui) {
                getBirims(ui.item.id);
                $("#MalAdi").val(ui.item.value);
            }
        });
        $("#MalAdi").autocomplete({
            source: "/WMS/Purchase/GetMalzemebyName/" + $("#SirketID").val(),
            minLength: 2,
            select: function (event, ui) {
                getBirims(ui.item.id);
                $("#MalAdi").val(ui.item.value);
            }
        });
        $(document).ready(function () {
            var table = $('#sample_7').DataTable({ "language": { "url": "http://cdn.datatables.net/plug-ins/1.10.13/i18n/Turkish.json" } });
            table.on('order.dt search.dt', function () {
                table.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    @if (ViewBag.Onay == false) { <text>if (i > 0) cell.innerHTML = i;</text> }else{ <text>cell.innerHTML = i + 1;</text> }

                });
            }).draw();
        });
        function editlist(id)
        {
            PartialView('/WMS/Purchase/EditList', 'tr' + id, JSON.stringify({ Id: id, s: $("#SirketID").val() }));
        }
        function getBirims(id)
        {
            $("#Birim option").remove();
            $.ajax({
                url: "/WMS/Purchase/GetBirim" ,
                type: 'POST',
                data: JSON.stringify({ kod: id, s: $("#SirketID").val() }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    if (data != "") {
                        if (data[0].Birim1.replace(" ", "") != "") { $('#Birim').append($('<option>', { value: data[0].Birim1, text: data[0].Birim1 })); }
                        if (data[0].Birim2.replace(" ", "") != "") { $('#Birim').append($('<option>', { value: data[0].Birim2, text: data[0].Birim2 })); }
                        if (data[0].Birim3.replace(" ", "") != "") { $('#Birim').append($('<option>', { value: data[0].Birim3, text: data[0].Birim3 })); }
                        if (data[0].Birim4.replace(" ", "") != "") { $('#Birim').append($('<option>', { value: data[0].Birim4, text: data[0].Birim4 })); }
                    }
                    $("#MalKodu").val(id);
                    $("#Miktar").focus();
                    $("#Miktar").select();
                }
            });
        }
        function Activate() {
            $.ajax({
                url: "/WMS/Purchase/Activate",
                data: JSON.stringify({ ID: @ViewBag.IrsaliyeId }),
                type: 'POST',
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    if (data.Status == false)
                        Modaldialog(data.Message, "Hata", "Tamam", "btn-danger");
                    else
                    {
                        Modaldialog("Görev onaylandı", "Başarı", "Tamam", "btn-success");
                        $('#submitForm').click();
                    }
                }
            });
        }
    </script>
}
